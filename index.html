<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>🎉 Aniversariantes • Mercatto Delícia</title>
<style>
:root{
  --bg:#0b1220;--card:#111827;--line:#1f2937;
  --text:#e5e7eb;--muted:#9ca3af;
  --brand:#22c55e;--sent:#3b82f6;
}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);color:var(--text);
}
.container{max-width:1000px;margin:16px auto;padding:0 12px}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:12px;padding:16px;
}
h1{text-align:center;margin:0 0 12px;font-size:1.3rem}
.filter{
  display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;
  justify-content:center
}
select,button{
  border-radius:8px;padding:8px 10px;font-size:.9rem
}
select{
  background:#0c1322;color:var(--text);
  border:1px solid var(--line);
}
button{
  border:none;cursor:pointer;font-weight:600;
  transition:opacity .2s;
}
button:hover{opacity:.85}
.btn-whats{
  background:var(--brand);color:#001a0c;border-radius:8px;
  padding:6px 10px;display:inline-flex;align-items:center;
  gap:6px;
}
.btn-whats.sent{
  background:var(--sent);color:#fff;
}
#msg{font-size:.9rem;margin-top:8px;color:var(--muted);text-align:center}
footer{text-align:center;color:var(--muted);font-size:.8rem;margin-top:20px}

/* ---------- Desktop tabela ---------- */
@media(min-width:700px){
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;text-align:left;border-bottom:1px solid var(--line)}
  th{color:var(--muted);font-weight:500}
}

/* ---------- Mobile cards ---------- */
@media(max-width:699px){
  table{display:none}
  .mobile-list{display:flex;flex-direction:column;gap:10px}
  .mcard{
    background:#0c1322;border:1px solid var(--line);
    border-radius:10px;padding:10px;
    display:flex;flex-direction:column;gap:6px;
  }
  .mcard strong{color:var(--muted);font-size:.85rem}
}
</style>
</head>
<body>
<div class="container">
  <h1>🎉 Aniversariantes • Mercatto Delícia</h1>
  <div class="card">
    <div class="filter">
      <select id="empresaFiltro"><option value="">Todas as empresas</option></select>
      <select id="mesFiltro"></select>
      <button onclick="filtrar()">🔍 Filtrar</button>
    </div>
    <div id="msg">Carregando aniversariantes...</div>
    <table id="tabela">
      <thead>
        <tr><th>Empresa</th><th>Nome</th><th>Aniversário</th><th>Telefone</th><th>Ações</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="mobile-list" id="mobileList"></div>
  </div>
</div>
<footer>© Mercatto Delícia • Sistema de Aniversariantes</footer>

<script>
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzEgyXiXkU6zoZ2zqj2LRBogArNucDMOLFLhSTQo3WKZjm8th9EfmozQz5BPYo0-Bi4Bw/exec";

let aniversariantes = [];
const enviados = JSON.parse(localStorage.getItem("aniversariosEnviados") || "[]");

// Escapa texto para HTML seguro
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}

// 🔹 Formata número no padrão 55 + DDD + número sem o 9
function formatarTelefone(num){
  if(!num) return "";
  const digits = num.replace(/\D/g,"");
  if(digits.length < 10) return digits;
  const ddd = digits.slice(0,2);
  let base = digits.slice(2);
  if(base.startsWith("9")) base = base.slice(1);
  return `55${ddd}${base}`;
}

async function carregar(){
  const msg=document.getElementById('msg');
  const tb=document.getElementById('tbody');
  msg.textContent='Carregando...'; tb.innerHTML='';
  try{
    const res=await fetch(GAS_API_URL);
    const data=await res.json();
    aniversariantes=data.aniversariantes||[];

    if(!aniversariantes.length){
      msg.textContent='Nenhum aniversariante encontrado.';return;
    }

    // 🔹 Popula filtro de empresas
    const empresas=[...new Set(aniversariantes.map(a=>a.empresa))];
    document.getElementById('empresaFiltro').innerHTML=
      '<option value="">Todas as empresas</option>'+
      empresas.map(e=>`<option value="${esc(e)}">${esc(e)}</option>`).join("");

    // 🔹 Popula filtro de meses
    const meses=["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];
    const mesSel=document.getElementById('mesFiltro');
    mesSel.innerHTML='<option value="">Todos os meses</option>'+
      meses.map((m,i)=>`<option value="${i+1}">${m}</option>`).join('');

    msg.textContent=`${aniversariantes.length} aniversariante(s) carregado(s).`;
    renderizar(aniversariantes);
  }catch(e){
    msg.textContent='⚠️ Erro: '+e.message;
  }
}

function filtrar(){
  const empresa=document.getElementById('empresaFiltro').value;
  const mesEscolhido=parseInt(document.getElementById('mesFiltro').value);
  let filtrados=aniversariantes;

  if(empresa)
    filtrados=filtrados.filter(a=>a.empresa===empresa);

  if(mesEscolhido)
    filtrados=filtrados.filter(a=>{
      const partes=a.aniversario.split('/');
      if(partes.length<2) return false;
      const mes=parseInt(partes[1]);
      return mes===mesEscolhido;
    });

  document.getElementById('msg').textContent=`${filtrados.length} aniversariante(s) encontrado(s).`;
  renderizar(filtrados);
}

function renderizar(lista){
  const tb=document.getElementById('tbody');
  const mob=document.getElementById('mobileList');
  tb.innerHTML=''; mob.innerHTML='';
  lista.forEach(a=>{
    const sent=enviados.includes(a.nome+a.aniversario);
    const fone=formatarTelefone(a.telefone||"");

    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(a.empresa)}</td>
      <td>${esc(a.nome)}</td>
      <td>${a.aniversario}</td>
      <td>${fone}</td>
      <td><button class="btn-whats ${sent?'sent':''}" onclick="enviar('${a.nome}','${a.aniversario}','${fone}','${a.empresa}',this)">🎁 WhatsApp</button></td>
    `;
    tb.appendChild(tr);

    const card=document.createElement('div');
    card.className='mcard';
    card.innerHTML=`
      <div><strong>Empresa:</strong> ${esc(a.empresa)}</div>
      <div><strong>Nome:</strong> ${esc(a.nome)}</div>
      <div><strong>Aniversário:</strong> ${a.aniversario}</div>
      <div><strong>Telefone:</strong> ${fone}</div>
      <button class="btn-whats ${sent?'sent':''}" onclick="enviar('${a.nome}','${a.aniversario}','${fone}','${a.empresa}',this)">🎁 WhatsApp</button>
    `;
    mob.appendChild(card);
  });
}

function enviar(nome, aniversario, telefone, empresa, btn){
  if(!telefone){alert('Telefone não encontrado.');return;}
  const mensagem = [
    `🎉 Olá ${nome}! Aqui é o *${empresa}* 💚`,
    ``,
    `Viemos te desejar um feliz aniversário! 🥂🎂`,
    `🎈 Você é nosso convidado especial para comemorar conosco esse mês tão especial!`,
    `📅 Seu aniversário é dia ${aniversario}, e preparamos um presente que vale o mês inteiro.`,
    ``,
    `📍 Faça sua reserva conosco.`,
    `Esperamos por você! ✨`
  ].join('\n');

  const link=`https://wa.me/${telefone}?text=${encodeURIComponent(mensagem)}`;
  window.open(link,'_blank');

  btn.classList.add('sent');
  if(!enviados.includes(nome+aniversario)){
    enviados.push(nome+aniversario);
    localStorage.setItem("aniversariosEnviados",JSON.stringify(enviados));
  }
}

document.addEventListener('DOMContentLoaded',carregar);
</script>
</body>
</html>
