<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>üéâ Aniversariantes ‚Ä¢ Mercatto Del√≠cia</title>
<style>
:root{
  --bg:#0b1220;--card:#111827;--line:#1f2937;
  --text:#e5e7eb;--muted:#9ca3af;
  --brand:#22c55e;--sent:#3b82f6;
}
body{
  margin:0;
  font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;
  background:var(--bg);color:var(--text);
}
.container{max-width:1000px;margin:16px auto;padding:0 12px}
.card{
  background:var(--card);border:1px solid var(--line);
  border-radius:12px;padding:16px;
}
h1{text-align:center;margin:0 0 12px;font-size:1.3rem}
.filter{
  display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;
  justify-content:center
}
input,select,button{
  border-radius:8px;padding:8px 10px;font-size:.9rem
}
input,select{
  background:#0c1322;color:var(--text);
  border:1px solid var(--line);
}
button{
  border:none;cursor:pointer;font-weight:600;
  transition:opacity .2s;
}
button:hover{opacity:.85}
.btn-whats{
  background:var(--brand);color:#001a0c;border-radius:8px;
  padding:6px 10px;display:inline-flex;align-items:center;
  gap:6px;
}
.btn-whats.sent{
  background:var(--sent);color:#fff;
}
#msg{font-size:.9rem;margin-top:8px;color:var(--muted);text-align:center}
footer{text-align:center;color:var(--muted);font-size:.8rem;margin-top:20px}

/* ---------- Desktop tabela ---------- */
@media(min-width:700px){
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:10px;text-align:left;border-bottom:1px solid var(--line)}
  th{color:var(--muted);font-weight:500}
}

/* ---------- Mobile cards ---------- */
@media(max-width:699px){
  table{display:none}
  .mobile-list{display:flex;flex-direction:column;gap:10px}
  .mcard{
    background:#0c1322;border:1px solid var(--line);
    border-radius:10px;padding:10px;
    display:flex;flex-direction:column;gap:6px;
  }
  .mcard strong{color:var(--muted);font-size:.85rem}
}
</style>
</head>
<body>
<div class="container">
  <h1>üéâ Aniversariantes ‚Ä¢ Mercatto Del√≠cia</h1>
  <div class="card">
    <div class="filter">
      <select id="empresaFiltro"><option value="">Todas as empresas</option></select>
      <input type="date" id="inicio">
      <input type="date" id="fim">
      <button onclick="filtrar()">üîç Filtrar</button>
      <button onclick="resetar()">‚ôªÔ∏è M√™s atual</button>
    </div>
    <div id="msg">Carregando aniversariantes...</div>
    <table id="tabela">
      <thead>
        <tr><th>Empresa</th><th>Nome</th><th>Anivers√°rio</th><th>Sugest√£o</th><th>A√ß√µes</th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    <div class="mobile-list" id="mobileList"></div>
  </div>
</div>
<footer>¬© Mercatto Del√≠cia ‚Ä¢ Sistema de Aniversariantes</footer>

<script>
const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzEgyXiXkU6zoZ2zqj2LRBogArNucDMOLFLhSTQo3WKZjm8th9EfmozQz5BPYo0-Bi4Bw/exec";
const RESERVA_URL = "https://grupodvbr.github.io/aniversariosmercatto/";

// üîπ URL da imagem do convite
const FOTO_URL = "https://github.com/grupodvbr/aniversarios/blob/main/paste/Imagem%20do%20WhatsApp%20de%202025-08-27%20%C3%A0(s)%2010.13.55_4efd54f3.jpg?raw=true";

let aniversariantes = [];
const enviados = JSON.parse(localStorage.getItem("aniversariosEnviados") || "[]");

function esc(s){return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m]))}
function formatDateInput(d){return d.toISOString().slice(0,10);}
function converterData(diaMes){
  const [dia,mes]=diaMes.split("/").map(Number);
  const ano=new Date().getFullYear();
  return `${ano}-${String(mes).padStart(2,"0")}-${String(dia).padStart(2,"0")}`;
}

async function carregar(){
  const msg=document.getElementById('msg');
  const tb=document.getElementById('tbody');
  msg.textContent='Carregando...'; tb.innerHTML='';
  try{
    const res=await fetch(GAS_API_URL);
    const data=await res.json();
    aniversariantes=data.aniversariantes||[];

    if(!aniversariantes.length){
      msg.textContent='Nenhum aniversariante encontrado.';return;
    }

    const empresas=[...new Set(aniversariantes.map(a=>a.empresa))];
    document.getElementById('empresaFiltro').innerHTML=
      '<option value="">Todas as empresas</option>'+
      empresas.map(e=>`<option value="${esc(e)}">${esc(e)}</option>`).join("");

    msg.textContent=`${aniversariantes.length} aniversariante(s) carregado(s).`;
    renderizar(aniversariantes);
  }catch(e){
    msg.textContent='‚ö†Ô∏è Erro: '+e.message;
  }
}

function renderizar(lista){
  const tb=document.getElementById('tbody');
  const mob=document.getElementById('mobileList');
  tb.innerHTML=''; mob.innerHTML='';
  lista.forEach(a=>{
    const sent=enviados.includes(a.nome+a.aniversario);
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${esc(a.empresa)}</td>
      <td>${esc(a.nome)}</td>
      <td>${a.aniversario}</td>
      <td>${esc(a.sugestao)}</td>
      <td><button class="btn-whats ${sent?'sent':''}" onclick="enviar('${a.nome}','${a.aniversario}','${a.telefone}','${a.empresa}',this)">üéÅ WhatsApp</button></td>
    `;
    tb.appendChild(tr);

    const card=document.createElement('div');
    card.className='mcard';
    card.innerHTML=`
      <div><strong>Empresa:</strong> ${esc(a.empresa)}</div>
      <div><strong>Nome:</strong> ${esc(a.nome)}</div>
      <div><strong>Anivers√°rio:</strong> ${a.aniversario}</div>
      ${a.sugestao?`<div><strong>Sugest√£o:</strong> ${esc(a.sugestao)}</div>`:''}
      <button class="btn-whats ${sent?'sent':''}" onclick="enviar('${a.nome}','${a.aniversario}','${a.telefone}','${a.empresa}',this)">üéÅ WhatsApp</button>
    `;
    mob.appendChild(card);
  });
}

function filtrar(){
  const empresa=document.getElementById('empresaFiltro').value;
  const inicio=document.getElementById('inicio').value;
  const fim=document.getElementById('fim').value;
  let filtrados=aniversariantes;

  if(empresa){filtrados=filtrados.filter(a=>a.empresa===empresa);}
  if(inicio && fim){
    const ini=new Date(inicio);
    const f=new Date(fim);
    filtrados=filtrados.filter(a=>{
      const conv=new Date(converterData(a.aniversario));
      return conv>=ini && conv<=f;
    });
  }
  document.getElementById('msg').textContent=`${filtrados.length} aniversariante(s) encontrado(s).`;
  renderizar(filtrados);
}

function enviar(nome, aniversario, telefone, empresa, btn){
  if(!telefone){alert('Telefone n√£o encontrado.');return;}

  // üîπ Mensagem com link da foto inclu√≠do
  const mensagem = [
    `üéâ Ol√° ${nome}! Aqui √© o *${empresa}*üéâ `,
    ``,
    `O Venho te deseja um feliz anivers√°rio! ü•ÇüéÇ`,
    `üéà Voc√™ √© nosso convidado especial para comemorar conosco esse m√™s t√£o especial!`,
    `Seu anivers√°rio √© dia ${aniversario}, mas, preparamos um presente que vale pelo m√™s inteiro`,
    ``,
    `üìç Fa√ßa sua reserva:`,

    `Esperamos por voc√™! ‚ú®`
  ].join('\n');

  const fone=telefone.replace(/\D/g,'');
  const params=new URLSearchParams({text:mensagem});
  const link=`https://wa.me/${fone}?${params.toString()}`;
  window.open(link,'_blank');

  btn.classList.add('sent');
  if(!enviados.includes(nome+aniversario)){
    enviados.push(nome+aniversario);
    localStorage.setItem("aniversariosEnviados",JSON.stringify(enviados));
  }
}

function resetar(){
  const d=new Date();
  const inicio=new Date(d.getFullYear(),d.getMonth(),1);
  const fim=new Date(d.getFullYear(),d.getMonth()+1,0);
  document.getElementById('inicio').value=formatDateInput(inicio);
  document.getElementById('fim').value=formatDateInput(fim);
  filtrar();
}

document.addEventListener('DOMContentLoaded',carregar);
</script>
</body>
</html>
